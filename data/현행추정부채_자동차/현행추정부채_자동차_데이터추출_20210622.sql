-- 자동차_원수_미경과보험료
SELECT BSC_CVR_CD, PDGR_CD, PDC_CD, INER_CHN_DVCD, USTK_DVCD,
		   SUM(LTPD_URND_PRM) AS LTPD_URND_PRM
	FROM FDMTAG02001
  WHERE CLG_YM = SUBSTR(:ET_PARM02,1,6)
  GROUP BY BSC_CVR_CD, PDGR_CD, PDC_CD, INER_CHN_DVCD, USTK_DVCD;

-- 자동차_비례출재_미경과보험료
SELECT BSC_CVR_CD, PDGR_CD, PDC_CD, INER_CHN_DVCD, USTK_DVCD,
		   SUM(RN_LTPD_URND_PRM) AS RN_LTPD_URND_PRM
	FROM FDMTAG02002
  WHERE CLG_YM = SUBSTR(:ET_PARM02,1,6)
  GROUP BY BSC_CVR_CD, PDGR_CD, PDC_CD, INER_CHN_DVCD, USTK_DVCD;

-- 자동차_비비례출재_미경과보험료(값 없음)
SELECT BSC_CVR_CD, PDGR_CD, PDC_CD, SL_CVR_CD, T02_RN_RINSC_CD,
       SUM(LTPD_URND_PRM) AS LTPD_URND_PRM
	FROM FDMTAG02008
  WHERE CLG_YM = SUBSTR(:ET_PARM02,1,6)
  GROUP BY BSC_CVR_CD, PDGR_CD, PDC_CD, SL_CVR_CD, T02_RN_RINSC_CD;

-- 자동차_예정보험료
/* UNIQUENESS OF INER_CHN_DVCD BY PLNO (PASS) */
--SELECT PLNO, COUNT(DISTINCT INER_CHN_DVCD)
--	FROM FDMTAG02001
--	WHERE CLG_YM = SUBSTR(:ET_PARM02,1,6)
--	GROUP BY PLNO
--	HAVING COUNT(DISTINCT INER_CHN_DVCD) > 1;
SELECT A.PDC_CD, A.PDGR_CD, A.BSC_CVR_CD, A.USTK_DVCD, B.INER_CHN_DVCD,
       SUM(EPCT_PRM) AS EPCT_PRM,
       SUM(RN_PRM) AS RN_PRM
	FROM FDMTAG02004 A
	LEFT OUTER JOIN (
		SELECT DISTINCT PLNO, INER_CHN_DVCD
			FROM FDMTAG02001
			WHERE CLG_YM = SUBSTR(:ET_PARM02,1,6)
	) B
		ON A.PLNO=B.PLNO
	WHERE SUBSTR(A.PYM_EPCT_DT,1,6) > A.CLG_YM
    AND A.CLG_YM = SUBSTR(:ET_PARM02,1,6)
    AND A.RPMN_YN = '0'
    GROUP BY A.PDC_CD, A.PDGR_CD, A.BSC_CVR_CD, A.USTK_DVCD, B.INER_CHN_DVCD;

-- 자동차_원수_개별추산액
SELECT BSC_CVR_CD, PDGR_CD, PDC_CD, INER_CHN_DVCD, USTK_DVCD,
       SUM(LTPD_OST_BNF) AS LTPD_OST_BNF
	FROM FDMTTC02001
  WHERE CLG_YM = SUBSTR(:ET_PARM02,1,6)
  GROUP BY BSC_CVR_CD, PDGR_CD, PDC_CD, INER_CHN_DVCD, USTK_DVCD;

-- 자동차_비례출재_개별추산액
SELECT BSC_CVR_CD, PDGR_CD, PDC_CD, INER_CHN_DVCD,
       SUM(RN_LTPD_OST_BNF) AS RN_LTPD_OST_BNF
	FROM FDMTTC02002
  WHERE CLG_YM = SUBSTR(:ET_PARM02,1,6)
  GROUP BY BSC_CVR_CD, PDGR_CD, PDC_CD, INER_CHN_DVCD;

-- 자동차_비비례출재_개별추산액
SELECT PDC_CD, T02_RN_RINSC_CD,
       SUM(WNCR_CNV_OST_RBNF) AS WNCR_CNV_OST_RBNF
	FROM FDMTTC02004
  WHERE CLG_YM = SUBSTR(:ET_PARM02,1,6)
  GROUP BY PDC_CD, T02_RN_RINSC_CD;

-- 자동차_원수_직전3년보험금손조비
SELECT BSC_CVR_CD, PDGR_CD, PDC_CD, INER_CHN_DVCD,
		   SUM(PYN_BNF) AS PYN_BNF,
       SUM(AT_DAG_IVMT) AS AT_DAG_IVMT
	FROM FDMTTC02001
  WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(SUBSTR(:ET_PARM02,1,6),'YYYYMM'),-35),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
  GROUP BY BSC_CVR_CD, PDGR_CD, PDC_CD, INER_CHN_DVCD;

-- 자동차_비례출재_직전3년보험금손조비
SELECT BSC_CVR_CD, PDGR_CD, PDC_CD, INER_CHN_DVCD,
		   SUM(RN_PYN_BNF) AS RN_PYN_BNF,
       NVL(SUM(RN_DAG_IVMT),0) AS RN_DAG_IVMT
	FROM FDMTTC02002
  WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(SUBSTR(:ET_PARM02,1,6),'YYYYMM'),-35),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
  GROUP BY BSC_CVR_CD, PDGR_CD, PDC_CD, INER_CHN_DVCD;

-- 자동차_비비례출재_직전3년보험금손조비
SELECT PDC_CD, T02_RN_RINSC_CD,
		   SUM(WNCR_CNV_DS_RBNF-WNCR_CNV_DS_RBNF_EX_AMT) AS WNCR_CNV_DS_RBNF_NET,
       SUM(WNCR_CNV_DAG_INV_CS) AS WNCR_CNV_DAG_INV_CS
	FROM FDMTTC02004
  WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(SUBSTR(:ET_PARM02,1,6),'YYYYMM'),-35),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
  GROUP BY PDC_CD, T02_RN_RINSC_CD;

-- 자동차_IBNR
SELECT RRNR_DVCD, BSC_CVR_CD,
       SUM(KRW_OS_AMT_E) AS KRW_OS_AMT_E
	FROM (
	SELECT TO_CHAR(AS_OF_DATE,'YYYYMM') AS CLG_YM
	     , CASE WHEN FUND_TYP_CD='10' THEN '01'
	            WHEN FUND_TYP_CD='11' THEN '02'
	            WHEN FUND_TYP_CD='12' THEN '03' END AS RRNR_DVCD
	     , SUBSTR(FCONT_ID,5,2) AS BSC_CVR_CD
	     , KRW_OS_AMT_E
	  FROM Q_CB_INST_NLA_LIC_IBNR
	  WHERE TO_CHAR(AS_OF_DATE,'YYYYMM') = SUBSTR(:ET_PARM02,1,6)
	)
	GROUP BY RRNR_DVCD, BSC_CVR_CD;

-- 자동차_보험금진전추이
-- ※ SQNO 여러개 아닌지 확인 후 뽑을 것!
SELECT PDGR_CD, AY, BASE_1,BASE_2, BASE_3, BASE_4, BASE_5, BASE_6, BASE_7
	FROM KICS_RISK_CF_NL_C
	WHERE BSE_YM = SUBSTR(:ET_PARM02,1,6)
		AND SQNO = '6';

-- 자동차_최종손해율
-- ※ SQNO 여러개 아닌지 확인 후 뽑을 것!
SELECT RRNR_DAT_DVCD, AT_CHN_DVCD, AT_PDGR_CD, FNAL_LSRT
	FROM FBMTST13201
  WHERE BSE_YM = SUBSTR(:ET_PARM02,1,6)
  	AND SQNO = '1'
    AND BSE_MON_DVCD = '12';

-- 자동차_사업비율
SELECT DISTINCT RRNR_DVCD, BOZ_CD, EXP_RT
	FROM KICS_PRM_RPT
	WHERE TO_CHAR(BASE_DATE,'YYYYMM') = SUBSTR(:ET_PARM02,1,6)
		AND SUBSTR(BOZ_CD, 0, 1) = 'B';

-- 자동차_코드맵핑
SELECT PDC_CD, PDGR_CD, BSC_CVR_CD, INER_CHN_DVCD, USTK_DVCD, AT_PDGR_CD, AT_BSC_CVR_CD, AT_CHN_DVCD
	FROM Q_NLA_CONV_CODE_MAPS
	WHERE APLY_END_DATE = '99991231';

-----------------------------------------------------------

-- 자동차_원수_직전1년경과보험료
SELECT '202012' AS CLG_YM,
       BSC_CVR_CD,
       PDGR_CD,
       PDC_CD,
       INER_CHN_DVCD,
		   SUM(ELP_PRM) AS ELP_PRM
	FROM FDMTAG02001
  WHERE CLG_YM BETWEEN '202001' AND '202012'
  GROUP BY
       BSC_CVR_CD,
       PDGR_CD,
       PDC_CD,
       INER_CHN_DVCD;

-- 자동차_비례출재_직전1년경과보험료
SELECT '202012' AS CLG_YM,
       BSC_CVR_CD,
       PDGR_CD,
       PDC_CD,
       INER_CHN_DVCD,
		   SUM(RN_ELP_PRM) AS RN_ELP_PRM
	FROM FDMTAG02002
  WHERE CLG_YM BETWEEN '202001' AND '202012'
  GROUP BY
       BSC_CVR_CD,
       PDGR_CD,
       PDC_CD,
       INER_CHN_DVCD;

-- 자동차_비비례출재_직전1년경과보험료
SELECT '202012' AS CLG_YM,
       BSC_CVR_CD,
       PDGR_CD,
       PDC_CD,
--       SL_CVR_CD,
			 T02_RN_RINSC_CD,
       SUM(ELP_PRM) AS ELP_PRM
	FROM FDMTAG02008
  WHERE CLG_YM BETWEEN '202001' AND '202012'
  GROUP BY
       BSC_CVR_CD,
       PDGR_CD,
       PDC_CD,
--       SL_CVR_CD,
			 T02_RN_RINSC_CD;

-- 자동차_원수_손해조사비율
SELECT '202012' AS CLG_YM,
       BSC_CVR_CD,
       PDGR_CD,
       PDC_CD,
       INER_CHN_DVCD,
		   SUM(PYN_BNF) AS PYN_BNF,
       SUM(AT_DAG_IVMT) AS AT_DAG_IVMT
	FROM FDMTTC02001
  WHERE CLG_YM BETWEEN '201801' AND '202012'
  GROUP BY
       BSC_CVR_CD,
       PDGR_CD,
       PDC_CD,
       INER_CHN_DVCD;

-- 자동차_비례출재_손해조사비율
SELECT '202012' AS CLG_YM,
       BSC_CVR_CD,
       PDGR_CD,
       PDC_CD,
       INER_CHN_DVCD,
		   SUM(RN_PYN_BNF) AS RN_PYN_BNF,
       SUM(RN_DAG_IVMT) AS RN_DAG_IVMT
	FROM FDMTTC02002
  WHERE CLG_YM BETWEEN '201801' AND '202012'
  GROUP BY
       BSC_CVR_CD,
       PDGR_CD,
       PDC_CD,
       INER_CHN_DVCD;

-- 자동차_비비례출재_손해조사비율
SELECT '202012' AS CLG_YM,
       PDC_CD,
       T02_RN_RINSC_CD,
		   SUM(WNCR_CNV_DS_RBNF-WNCR_CNV_DS_RBNF_EX_AMT) AS WNCR_CNV_DS_RBNF_NET,
       SUM(WNCR_CNV_DAG_INV_CS) AS WNCR_CNV_DAG_INV_CS
	FROM FDMTTC02004
  WHERE CLG_YM BETWEEN '201801' AND '202012'
  GROUP BY
       PDC_CD,
       T02_RN_RINSC_CD;

-- 자동차_IBNR
SELECT CLG_YM
     , RRNR_DVCD
     , BSC_CVR_CD
     , SUM(KRW_OS_AMT_E) AS KRW_OS_AMT_E
	FROM (
	SELECT TO_CHAR(AS_OF_DATE,'YYYYMM') AS CLG_YM
	     , CASE WHEN FUND_TYP_CD='10' THEN '01'
	            WHEN FUND_TYP_CD='11' THEN '02'
	            WHEN FUND_TYP_CD='12' THEN '03' END AS RRNR_DVCD
	     , SUBSTR(FCONT_ID,5,2) AS BSC_CVR_CD
	     , KRW_OS_AMT_E
	  FROM Q_CB_INST_NLA_LIC_IBNR
	  WHERE TO_CHAR(AS_OF_DATE,'YYYYMM') = '202012'
	)
	GROUP BY CLG_YM
      , RRNR_DVCD
      , BSC_CVR_CD
;

-- 자동차_보험금진전추이
-- ※ SQNO 여러개 아닌지 확인 후 뽑을 것!
SELECT BSE_YM, PDGR_CD, AY, BASE_1,BASE_2, BASE_3, BASE_4, BASE_5, BASE_6, BASE_7
	FROM KICS_RISK_CF_NL_C WHERE BSE_YM = '202012';

-- 자동차_최종손해율
-- ※ SQNO 여러개 아닌지 확인 후 뽑을 것!
SELECT BSE_YM, BSE_MON_DVCD, RRNR_DAT_DVCD, AT_CHN_DVCD, AT_PDGR_CD, FNAL_LSRT
	FROM FBMTST13201
  WHERE BSE_YM = '202012'
  	AND SQNO = '1'
    AND BSE_MON_DVCD = '12'
  ORDER BY 3, 4, 5;

-- 자동차_사업비율
SELECT DISTINCT
     BASE_DATE,
     CASE WHEN RRNR_DVCD IN ('01','02') THEN '04'
            WHEN RRNR_DVCD IN ('03') THEN '03'
            END AS RRNR_DVCD,
     BOZ_CD,
     EXP_RT
FROM KICS_PRM_RPT
WHERE TO_CHAR(BASE_DATE,'YYYYMM')='201912'
	AND SUBSTR(BOZ_CD, 0, 1) = 'B'
ORDER BY 1,2,3;

---------------------------------------------------------------------------------------------------------------
-- 수수료연동구분포함
-- 자동차_원수_미경과보험료
SELECT CLG_YM,
       BSC_CVR_CD,
       PDGR_CD,
       PDC_CD,
       INER_CHN_DVCD,
       CASE WHEN PLNO IN (
       		SELECT PLNO
        		FROM FDMTAG02002
        		WHERE CLG_YM = '202012'
       ) THEN 'V' ELSE 'NV' END AS CMSN_DVCD,
		   SUM(LTPD_URND_PRM) AS LTPD_URND_PRM
	FROM FDMTAG02001
  WHERE CLG_YM = '202012'
  GROUP BY
       CLG_YM,
       BSC_CVR_CD,
       PDGR_CD,
       PDC_CD,
       INER_CHN_DVCD,
       CASE WHEN PLNO IN (
       		SELECT PLNO
        		FROM FDMTAG02002
        		WHERE CLG_YM = '202012'
       ) THEN 'V' ELSE 'NV' END;

-- 자동차_원수_개별추산액
SELECT CLG_YM,
       BSC_CVR_CD,
       PDGR_CD,
       PDC_CD,
       INER_CHN_DVCD,
       CASE WHEN PLNO IN (
       		SELECT PLNO
        		FROM FDMTTC02002
        		WHERE CLG_YM = '202012'
       ) THEN 'V' ELSE 'NV' END AS CMSN_DVCD,
       SUM(LTPD_OST_BNF) AS LTPD_OST_BNF
	FROM FDMTTC02001
  WHERE CLG_YM = '202012'
  GROUP BY
       CLG_YM,
       BSC_CVR_CD,
       PDGR_CD,
       PDC_CD,
       INER_CHN_DVCD,
       CASE WHEN PLNO IN (
       		SELECT PLNO
        		FROM FDMTTC02002
        		WHERE CLG_YM = '202012'
       ) THEN 'V' ELSE 'NV' END;

-- 자동차_원수_직전1년경과보험료(285.346초)
/*+FULL(a) FULL(b) PARALLEL(8)*/
SELECT CLG_YM,
       BSC_CVR_CD,
       PDGR_CD,
       PDC_CD,
       INER_CHN_DVCD,
       CASE WHEN PLNO IN (
       		SELECT PLNO
        		FROM FDMTAG02002 b
        		WHERE CLG_YM BETWEEN '202001' AND '202012'
       ) THEN 'V' ELSE 'NV' END AS CMSN_DVCD,
		   SUM(ELP_PRM) AS ELP_PRM
	FROM FDMTAG02001 a
  WHERE CLG_YM BETWEEN '202001' AND '202012'
  GROUP BY
       CLG_YM,
       BSC_CVR_CD,
       PDGR_CD,
       PDC_CD,
       INER_CHN_DVCD,
       CASE WHEN PLNO IN (
       		SELECT PLNO
        		FROM FDMTAG02002 b
        		WHERE CLG_YM BETWEEN '202001' AND '202012'
       ) THEN 'V' ELSE 'NV' END;