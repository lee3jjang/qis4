/*
   RRNR_DAT_DVCD : 원수=1, 제공제=2, 수재=3
   RRNR_CTC_BZ_DVCD : 국내=3, 해외=2
   POOL_DVCD : 구분없음='', 화보협회=1, 손보협회=2, 원자력=3, 원자력(미국)=4, 원자력(원수-원자력/수재-미국제외)=5, MT=6, 전월가마감=7, 계수조정=8
   RN_KND_CD : 비례임의=FP, 비례특약=TP, 비비례특약=TN, 비비례임의=FN, 일괄임의=AP, 구분없음=null
   CMSN_DVCD : 잠정수수료=1, 확정수수료=2
   INRI_RN_KND_CD : 구분없음=null, 비례특약=TP, 비비례특약=TN, 제공제특약=TJ, 비례임의=FP, 비비례임의=FN
*/


/**********************************************************/
/*           Ⅰ. 일반_원수_직전1년경과보험료 ('19.12 기준)           */
/**********************************************************/

-- 1. [보유구분별] (원수) 1조 404억, (수재) 1,170억, (제공제) 97억
SELECT RRNR_DAT_DVCD, SUM(ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04001
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
	GROUP BY RRNR_DAT_DVCD
	ORDER BY 2 DESC;

-- 2. [국내외구분별] (국내) 8,629억, (해외) 3,042억
SELECT RRNR_CTC_BZ_DVCD, SUM(ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04001
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
	GROUP BY RRNR_CTC_BZ_DVCD
	ORDER BY 2 DESC;

-- 3. [지역별] (한국) 8,592억, (미국) 2,544억, (중국) 222억 등
SELECT NTNL_CTRY_CD, SUM(ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04001
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
	GROUP BY NTNL_CTRY_CD
	ORDER BY 2 DESC;

/*
	3-1. [국내외구분 및 지역구분 정합성 검사]
   ㆍ국내외구분이 국내이나, 지역구분이 KR 인 경우 있음 => 지역구분=KR 처리
   ㆍ지역구분이 KR인데, 국내외구분이 해외인 경우는 없음
*/
SELECT RRNR_CTC_BZ_DVCD, NTNL_CTRY_CD, SUM(ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04001
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
		AND ((RRNR_CTC_BZ_DVCD=3 AND NTNL_CTRY_CD!='KR') OR (RRNR_CTC_BZ_DVCD!=3 AND NTNL_CTRY_CD='KR'))
	GROUP BY RRNR_CTC_BZ_DVCD, NTNL_CTRY_CD
	ORDER BY 3 DESC;

-- 4. [POOL구분별] (구분없음) 1조 1,551억, 화보협회 50억 등
SELECT POOL_DVCD, SUM(ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04001
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
	GROUP BY POOL_DVCD
	ORDER BY 2 DESC;

/*
	4-1. [POOL구분 중 원자력 정합성 검사]
	 ㆍPOOL_DVCD IN ('3', '4', '5') 면 ARC_INPL_CD = '1069010' 이고, 그 역도 성립
*/
SELECT POOL_DVCD, ARC_INPL_CD, SUM(ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04001
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
		AND (POOL_DVCD IN ('3', '4', '5') OR ARC_INPL_CD = '1069010')
	GROUP BY POOL_DVCD, ARC_INPL_CD
	ORDER BY 3 DESC;

/*
	4-2. [원자력관련 국내외구분 및 보유구분 정합성 검사]
	 ㆍARC_INPL_CD='1069010' 인 데이터의 경우, RRNR_DAT_DVCD='01'이면 RRNR_CTC_BZ_DVCD='2' 이어야 함
	   - 즉, 원자력 원수는 무조건 국내임(원자력은 해외원수를 하지 않음)
	 ㆍ현재는 RRNR_DAT_DVCD='01'이면 RRNR_CTC_BZ_DVCD='3'로 되어 있음(RRNR_CTC_BZ_DVCD 강제수정 필요)
*/
SELECT RRNR_CTC_BZ_DVCD, RRNR_DAT_DVCD, SUM(ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04001
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
		AND ARC_INPL_CD = '1069010'
	GROUP BY RRNR_CTC_BZ_DVCD, RRNR_DAT_DVCD
	ORDER BY 3 DESC;

-- 5. [수재구분별] (null) 1조 434억, (비례특약) 923억, (비비례특약) 178억 (제공제특약) 96억 등
SELECT INRI_RN_KND_CD, SUM(ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04001
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
	GROUP BY INRI_RN_KND_CD
	ORDER BY 2 DESC;


/*
	5-1. [수재구분 및 보유구분 정합성 검사] RRNR_DAT_DVCD가 원수가 아니나 수재종류코드가 없는 경우 있음 => TP로 처리
*/
SELECT INRI_RN_KND_CD, RRNR_DAT_DVCD, SUM(ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04001
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
		AND ((RRNR_DAT_DVCD != '01' AND INRI_RN_KND_CD IS NULL)
			OR (RRNR_DAT_DVCD = '01' AND INRI_RN_KND_CD IS NOT NULL))
	GROUP BY INRI_RN_KND_CD, RRNR_DAT_DVCD
	ORDER BY 3 DESC;

/*
	5-2. [제공제특약 관련] 확인 중
*/
SELECT INRI_RN_KND_CD, ARC_INPL_CD, SUM(ELP_PRM) AS ELP_PRM
	FROM FDMTAG04001
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
		AND INRI_RN_KND_CD = 'TJ'
	GROUP BY INRI_RN_KND_CD, ARC_INPL_CD
	ORDER BY 3 DESC;



/**********************************************************/
/*           Ⅱ. 일반_출재_직전1년경과보험료 ('19.12 기준)           */
/**********************************************************/

-- 1. [보유구분별] (원수출재) 4,413억, (수재출재) 305억, (XOL) 297억
SELECT RRNR_DAT_DVCD, SUM(T02_RN_ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
	GROUP BY RRNR_DAT_DVCD
	ORDER BY 2 DESC;

-- 2. [국내외구분별] (국내) 4,097억, (해외) 917억
SELECT RRNR_CTC_BZ_DVCD, SUM(T02_RN_ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
	GROUP BY RRNR_CTC_BZ_DVCD
	ORDER BY 2 DESC;

-- 3. [지역별] (한국) 4,093억, (미국) 918억, (전세계) 3억 등
SELECT NTNL_CTRY_CD, SUM(T02_RN_ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
	GROUP BY NTNL_CTRY_CD
	ORDER BY 2 DESC;

/*
	3-1. [국내외구분 및 지역구분 정합성 검사]
   ㆍ국내외구분이 국내이나, 지역구분이 KR 인 경우 있음 => 지역구분=KR 처리
   ㆍ지역구분이 KR인데, 국내외구분이 해외인 경우는 없음
*/
SELECT RRNR_CTC_BZ_DVCD, NTNL_CTRY_CD, SUM(T02_RN_ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
		AND ((RRNR_CTC_BZ_DVCD=3 AND NTNL_CTRY_CD!='KR') OR (RRNR_CTC_BZ_DVCD!=3 AND NTNL_CTRY_CD='KR'))
	GROUP BY RRNR_CTC_BZ_DVCD, NTNL_CTRY_CD
	ORDER BY 3 DESC;

-- 4. [POOL구분별] (구분없음) 4,950억, (MT) 2,570억 등
SELECT POOL_DVCD, SUM(T02_RN_ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
	GROUP BY POOL_DVCD
	ORDER BY 2 DESC;

/*
	4-1. [POOL구분 중 원자력 정합성 검사]
	 ㆍPOOL_DVCD IN ('3', '4', '5') 면 ARC_INPL_CD = '1069010' 이고, 그 역도 성립
*/
SELECT POOL_DVCD, ARC_INPL_CD, SUM(T02_RN_ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
		AND (POOL_DVCD IN ('3', '4', '5') OR ARC_INPL_CD = '1069010')
	GROUP BY POOL_DVCD, ARC_INPL_CD
	ORDER BY 3 DESC;

/*
	4-2. [원자력관련 국내외구분 및 보유구분 정합성 검사]
	 ㆍARC_INPL_CD='1069010' 인 데이터의 경우, RRNR_DAT_DVCD='01'이면 RRNR_CTC_BZ_DVCD='2' 이어야 함
	  - 즉, 원자력 원수는 무조건 국내임(원자력은 해외원수를 하지 않음)
	 ㆍ현재는 RRNR_DAT_DVCD='01'이면 RRNR_CTC_BZ_DVCD='3'로 되어 있음(RRNR_CTC_BZ_DVCD 강제수정 필요)
*/
SELECT RRNR_CTC_BZ_DVCD, RRNR_DAT_DVCD, SUM(T02_RN_ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
		AND ARC_INPL_CD = '1069010'
	GROUP BY RRNR_CTC_BZ_DVCD, RRNR_DAT_DVCD
	ORDER BY 3 DESC;

-- 5. [출재종류] (비례임의) 2,416억, (비례특약) 1,937억, (null) 316억, (비비례특약) 297억, (비비례임의) 48억, (일괄임의) 0.2억
--  ㆍnull값 있음
--  ㆍ비비례임의 있음
--  ㆍAP 식별 불명확
SELECT RN_KND_CD, SUM(T02_RN_ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
	GROUP BY RN_KND_CD
	ORDER BY 2 DESC;

/*
	5-1. [출재종류 및 보유구분 정합성 검사]
	ㆍRRNR_DAT_DVCD='04'면 RN_KND_CD='TN'이나 그 역은 성립하지 않음
*/
SELECT RRNR_DAT_DVCD, RN_KND_CD, SUM(T02_RN_ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
		AND (RRNR_DAT_DVCD='04' OR RN_KND_CD='TN')
	GROUP BY RRNR_DAT_DVCD, RN_KND_CD
	ORDER BY 3 DESC;

-- 6. [특약임의구분] (임의) 2,695억 (특약) 2,337억 등
--  ㆍnull과 '' 둘 다 있음
SELECT TTY_FAC_DVCD, SUM(T02_RN_ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
	GROUP BY TTY_FAC_DVCD
	ORDER BY 2 DESC;

/*
	6-1. [특약임의구분 및 출재종류 정합성 검사]
	 ㆍTTY_FAC_DVCD이 특약인데, RN_KND_CD가 임의인 경우, TTY_FAC_DVCD가 임의인데 RN_KND_CD가 특약인 경우 있음 => RN_KND_CD 적용(TTY_FAC_DVCD 삭제)
*/
SELECT TTY_FAC_DVCD, RN_KND_CD, SUM(T02_RN_ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
		AND NOT ((RN_KND_CD IN ('FP', 'FN', 'AP') AND TTY_FAC_DVCD = '2')
	 	  OR (RN_KND_CD IN ('TP', 'TN') AND TTY_FAC_DVCD = '1')
	 	  OR (RN_KND_CD IS NULL AND TTY_FAC_DVCD = '')
	 	  OR (RN_KND_CD IS NULL AND TTY_FAC_DVCD IS NULL))
	GROUP BY TTY_FAC_DVCD, RN_KND_CD
	ORDER BY 3 DESC;

-- 7. [재보험자구분] (코리안리) 3,232억 등, 총 327개의 재보험사코드 존재
SELECT T02_RN_RINSC_CD, SUM(T02_RN_ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
	GROUP BY T02_RN_RINSC_CD
	ORDER BY 2 DESC;

-- 8. [재보험특약코드] (임의) 2,113억, (null) 300억 등, 총 564개의 특약코드 존재 (null 및 임의 포함)
SELECT RRNR_TTY_CD, SUM(T02_RN_ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
	GROUP BY RRNR_TTY_CD
	ORDER BY 2 DESC;

/*
	8-1. [재보험특약구분 및 출재종류 정합성 검사]
	 ㆍRN_KND_CD이 임의인데, RRNR_TTY_CD가 특약인 경우 혹은 RN_KND_CD가 특약임의 RRNR_TTY_CD가 임의인 경우 있음 => RN_KND_CD 적용(?)
	 ㆍ정합성 검사 조건문이 부정확할 수 있음(RRNR_TTY_CD LIKE 관련)
*/
SELECT RN_KND_CD, RRNR_TTY_CD, SUM(T02_RN_ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
		AND ((RN_KND_CD IN ('FP', 'FN', 'AP') AND RRNR_TTY_CD NOT LIKE '%F%')
			OR (RN_KND_CD IN ('TP', 'TN') AND RRNR_TTY_CD = 'FAC00000000001'))
	GROUP BY RN_KND_CD, RRNR_TTY_CD
	ORDER BY 3 DESC;

-- 9. [수수료구분코드] (null) 2,736억, (확정수수료) 1,803억, (잠정수수료) 475억
SELECT CMSN_DVCD, SUM(T02_RN_ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
	GROUP BY CMSN_DVCD
	ORDER BY 2 DESC;

/*
	9-1. [수수료구분, 비례비비례 및 특약임의 정합성 검사]
	 ㆍRN_KND_CD이 임의인데, CMSN_DVCD가 잠정수수료인 경우 있음 => 매우 작으므로 무시 (확정수수료 처리)
	 ㆍRN_KND_CD이 비비례인데, CMSN_DVCD가 잠정수수료인 경우 있음 => 매우 작으므로 무시 (확정수수료 처리)
*/
SELECT CMSN_DVCD, RN_KND_CD, SUM(T02_RN_ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
		AND (RN_KND_CD IN ('FP', 'FN', 'AP', 'TN') AND CMSN_DVCD = '1')
	GROUP BY CMSN_DVCD, RN_KND_CD
	ORDER BY 3 DESC;

/*
	9-2. [수수료구분이 없는 데이터 검사] (비례임의) 2,076억, (null) 316억, (비비례특약) 297억, (비비례임의) 48억
	 ㆍ수수료구분 없으면 확정수수료 처리
*/
SELECT RN_KND_CD, SUM(T02_RN_ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
		AND CMSN_DVCD IS NULL
	GROUP BY RN_KND_CD
	ORDER BY 2 DESC;

/*
  9-3. [증권번호별 수수료구분 검사] 한 증권 내에 CMSN_DVCD가 1, 2 모두 있는 경우 : 165,840건
   ㆍMIN 처리 후 NVL (즉, 둘 다 있으면 잠점수수료 처리)
*/
SELECT PLNO
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
	GROUP BY PLNO
	HAVING COUNT(DISTINCT NVL(CMSN_DVCD,'2'))>1;

/*
  10. [원수/출재 계약 증권번호 정합성 검사] 출재에는 있지만 원수에는 없는 증권번호
   ㆍ(MT) 2,570억, (구분없음) 297억, (전월가마감) -2,236억 등
*/
SELECT POOL_DVCD, SUM(T02_RN_ELP_PRM)/1E8 AS ELP_PRM
	FROM FDMTAG04002 A
	WHERE A.CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
		AND NOT EXISTS (SELECT 1 FROM FDMTAG04001 B WHERE A.PLNO=B.PLNO)
	GROUP BY POOL_DVCD
	ORDER BY 2 DESC;


/***************************** 일반_직전1년경과보험료 ********************************/
SELECT SUBSTR(:ET_PARM02,1,6) AS CLG_YM
     , POOL_DVCD
     , RRNR_DVCD
     , PDC_CD
     , RN_KND_CD
     , NTNL_CTRY_CD
     , CNNT_CMSN_DVCD
     , SUM(ELP_PRM) AS ELP_PRM
	FROM (
		SELECT DECODE(A.POOL_DVCD,' ','0',A.POOL_DVCD) AS POOL_DVCD
		     , DECODE(A.RRNR_DAT_DVCD,'01','01','02') AS RRNR_DVCD
		     , INRI_RN_KND_CD AS RN_KND_CD  -- TODO: 재정의 필요
		     , CASE WHEN A.ARC_INPL_CD='1069010' AND A.RRNR_DAT_DVCD='01' THEN 'KR'
		            WHEN A.RRNR_CTC_BZ_DVCD='3' THEN 'KR'
		            ELSE A.NTNL_CTRY_CD END AS NTNL_CTRY_CD
		     , SUBSTR(A.ARC_INPL_CD,1,5) AS PDC_CD
		     , (SELECT NVL(MIN(B.CMSN_DVCD),'2') FROM FDMTAG04002 B WHERE B.PLNO=A.PLNO AND B.CLG_YM<=SUBSTR(:ET_PARM02,1,6)) AS CNNT_CMSN_DVCD
--         , NVL(B.CMSN_DVCD,'2') AS CNNT_CMSN_DVCD
         , NULL AS RN_RINSC_CD
		     , A.ELP_PRM AS ELP_PRM
			FROM FDMTAG04001 A
--			LEFT OUTER JOIN (
--				SELECT PLNO, NVL(MIN(CMSN_DVCD),'2') AS CMSN_DVCD FROM FDMTAG04002 GROUP BY PLNO
--			) B
--				ON A.PLNO=B.PLNO
			WHERE A.CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)

		UNION

		SELECT DECODE(A.POOL_DVCD,' ','0',A.POOL_DVCD) AS POOL_DVCD
		     , '03' AS RRNR_DVCD -- 원수: DECODE(RRNR_DAT_DVCD,'01','01','02')
		     , A.RN_KND_CD -- TODO: 재정의 필요
		     , CASE WHEN A.ARC_INPL_CD='1069010' AND A.RRNR_DAT_DVCD='01' THEN 'KR'
				        WHEN A.RRNR_CTC_BZ_DVCD='3' THEN 'KR'
				        ELSE A.NTNL_CTRY_CD END AS NTNL_CTRY_CD
				 , SUBSTR(A.ARC_INPL_CD,1,5) AS PDC_CD
		     , NVL(A.CMSN_DVCD,'2') AS CNNT_CMSN_DVCD -- 원수: NVL(MIN(CMSN_DVCD),'2') (GROUP BY PLNO)
		     , T02_RN_RINSC_CD AS RN_RINSC_CD
		     , A.T02_RN_ELP_PRM AS ELP_PRM
			FROM FDMTAG04002 A
			WHERE A.CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
	)
	GROUP BY POOL_DVCD, RRNR_DVCD, PDC_CD, RN_KND_CD, NTNL_CTRY_CD, CNNT_CMSN_DVCD, RN_RINSC_CD;
/**********************************************************************************/


/***************************** 일반_미경과보험료 ********************************/
SELECT SUBSTR(:ET_PARM02,1,6) AS CLG_YM
     , POOL_DVCD
     , RRNR_DVCD
     , PDC_CD
     , RN_KND_CD
     , NTNL_CTRY_CD
     , CNNT_CMSN_DVCD
     , SUM(LTPD_URND_PRM) AS LTPD_URND_PRM
	FROM (
		SELECT DECODE(A.POOL_DVCD,' ','0',A.POOL_DVCD) AS POOL_DVCD
		     , DECODE(A.RRNR_DAT_DVCD,'01','01','02') AS RRNR_DVCD
		     , INRI_RN_KND_CD AS RN_KND_CD  -- TODO: 재정의 필요
		     , CASE WHEN A.ARC_INPL_CD='1069010' AND A.RRNR_DAT_DVCD='01' THEN 'KR'
		            WHEN A.RRNR_CTC_BZ_DVCD='3' THEN 'KR'
		            ELSE A.NTNL_CTRY_CD END AS NTNL_CTRY_CD
		     , SUBSTR(A.ARC_INPL_CD,1,5) AS PDC_CD
		     , (SELECT NVL(MIN(B.CMSN_DVCD),'2') FROM FDMTAG04002 B WHERE B.PLNO=A.PLNO AND B.CLG_YM<=SUBSTR(:ET_PARM02,1,6)) AS CNNT_CMSN_DVCD
--         , NVL(B.CMSN_DVCD,'2') AS CNNT_CMSN_DVCD
         , NULL AS RN_RINSC_CD
		     , A.LTPD_URND_PRM AS LTPD_URND_PRM
			FROM FDMTAG04001 A
--			LEFT OUTER JOIN (
--				SELECT PLNO, NVL(MIN(CMSN_DVCD),'2') AS CMSN_DVCD FROM FDMTAG04002 GROUP BY PLNO
--			) B
--				ON A.PLNO=B.PLNO
			WHERE A.CLG_YM = SUBSTR(:ET_PARM02,1,6)

		UNION

		SELECT DECODE(A.POOL_DVCD,' ','0',A.POOL_DVCD) AS POOL_DVCD
		     , '03' AS RRNR_DVCD -- 원수: DECODE(RRNR_DAT_DVCD,'01','01','02')
		     , A.RN_KND_CD -- TODO: 재정의 필요
		     , CASE WHEN A.ARC_INPL_CD='1069010' AND A.RRNR_DAT_DVCD='01' THEN 'KR'
				        WHEN A.RRNR_CTC_BZ_DVCD='3' THEN 'KR'
				        ELSE A.NTNL_CTRY_CD END AS NTNL_CTRY_CD
				 , SUBSTR(A.ARC_INPL_CD,1,5) AS PDC_CD
		     , NVL(A.CMSN_DVCD,'2') AS CNNT_CMSN_DVCD -- 원수: NVL(MIN(CMSN_DVCD),'2') (GROUP BY PLNO)
		     , T02_RN_RINSC_CD AS RN_RINSC_CD
		     , A.T02_LTPD_RN_URND_PRM AS LTPD_URND_PRM
			FROM FDMTAG04002 A
			WHERE A.CLG_YM = SUBSTR(:ET_PARM02,1,6)
	)
	GROUP BY POOL_DVCD, RRNR_DVCD, PDC_CD, RN_KND_CD, NTNL_CTRY_CD, CNNT_CMSN_DVCD, RN_RINSC_CD;
/**********************************************************************************/



/**********************************************************/
/*                     Ⅲ. 일반_상품정보                       */
/**********************************************************/

-- 1. 상품코드 유일성 검사 (PASS)
SELECT PDC_CD, COUNT(*) FROM (
	SELECT DISTINCT PDC_CD, PDC_NM,
			   PDGR_CD, PDGR_NM
		FROM FDWTTP01011
	  ORDER BY 1
	)
GROUP BY PDC_CD
HAVING COUNT(*) > 1;

-- 2. 상품군코드별 상품군명 유일성 검사 (PASS)
SELECT PDGR_CD, COUNT(*) FROM (
	SELECT DISTINCT PDGR_CD, PDGR_NM
		FROM FDWTTP01011
	  ORDER BY 1
	)
GROUP BY PDGR_CD
HAVING COUNT(*) > 1;

/***************************** 일반_상품정보 ********************************/
SELECT DISTINCT PDC_CD, PDC_NM,
       PDGR_CD, REPLACE(PDGR_NM,'일반/','') AS PDGR_NM
		FROM FDWTTP01011
	  ORDER BY 1;
SELECT DISTINCT PDGR_NM FROM FDWTTP01011;
/************************************************************************/


/**********************************************************/
/*                      Ⅳ. 국가구분정보                       */
/**********************************************************/

/****************************** 국가구분정보 ********************************/
SELECT A.CNTR_CD AS NTNL_CTRY_CD, A.CNTR_CD_NM, B.KICS_CNTR_CATG_CD, B.KICS_CNTR_CATG_NM
	FROM KICS_CNTR_GRP_MAP_NL A, KICS_CNTR_GRP_NL B
	WHERE A.CNTR_CATG_CD=B.CNTR_CATG_CD;
/************************************************************************/

