-- 일반_원수_미경과보험료 (2021.07.23)
SELECT RRNR_DAT_DVCD, RRNR_CTC_BZ_DVCD, SUBSTR(ARC_INPL_CD,1,5) AS PDC_CD, INER_CHN_DVCD, NTNL_CTRY_CD, INRI_RN_KND_CD,
	  	 CASE WHEN EXISTS (SELECT 1 FROM FDMTAG04002 B WHERE B.CMSN_DVCD = '1' AND B.PLNO = A.PLNO AND B.CLG_YM = SUBSTR(:ET_PARM02,1,6)) THEN '01' ELSE '02' END AS CMSN_DVCD,
       SUM(LTPD_URND_PRM) AS OGL_URND_PRM
	FROM FDMTAG04001 A
	WHERE CLG_YM = SUBSTR(:ET_PARM02,1,6)
	GROUP BY RRNR_DAT_DVCD, RRNR_CTC_BZ_DVCD, SUBSTR(ARC_INPL_CD,1,5), INER_CHN_DVCD, NTNL_CTRY_CD, INRI_RN_KND_CD,
		  		 CASE WHEN EXISTS (SELECT 1 FROM FDMTAG04002 B WHERE B.CMSN_DVCD = '1' AND B.PLNO = A.PLNO AND B.CLG_YM = SUBSTR(:ET_PARM02,1,6)) THEN '01' ELSE '02' END;

-- 일반_출재_미경과보험료 (2021.07.23)
SELECT RRNR_CTC_BZ_DVCD, SUBSTR(ARC_INPL_CD,1,5) AS PDC_CD, INER_CHN_DVCD, NTNL_CTRY_CD, RN_KND_CD, T02_RN_RINSC_CD,
       CASE WHEN CMSN_DVCD = '1' THEN '01' ELSE '02' END AS CMSN_DVCD,
       SUM(T02_LTPD_RN_URND_PRM) AS RN_URND_PRM
	FROM FDMTAG04002
	WHERE CLG_YM = SUBSTR(:ET_PARM02,1,6)
	GROUP BY RRNR_CTC_BZ_DVCD, SUBSTR(ARC_INPL_CD,1,5), INER_CHN_DVCD, NTNL_CTRY_CD, RN_KND_CD, T02_RN_RINSC_CD,
				   CASE WHEN CMSN_DVCD = '1' THEN '01' ELSE '02' END;


-- 일반_원수_직전1년경과보험료 (2021.07.23)
--SELECT RRNR_DAT_DVCD, RRNR_CTC_BZ_DVCD, SUBSTR(ARC_INPL_CD,1,5) AS PDC_CD, INER_CHN_DVCD, NTNL_CTRY_CD, INRI_RN_KND_CD,
--	  	 CASE WHEN EXISTS (SELECT 1 FROM FDMTAG04002 B WHERE B.CMSN_DVCD = '1' AND B.PLNO = A.PLNO AND B.CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)) THEN '01' ELSE '02' END AS CMSN_DVCD,
--       SUM(ELP_PRM) AS OGL_ELP_PRM
--	FROM FDMTAG04001 A
--	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
--	GROUP BY RRNR_DAT_DVCD, RRNR_CTC_BZ_DVCD, SUBSTR(ARC_INPL_CD,1,5), INER_CHN_DVCD, NTNL_CTRY_CD, INRI_RN_KND_CD,
--		  		 CASE WHEN EXISTS (SELECT 1 FROM FDMTAG04002 B WHERE B.CMSN_DVCD = '1' AND B.PLNO = A.PLNO AND B.CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)) THEN '01' ELSE '02' END;
SELECT RRNR_DAT_DVCD, RRNR_CTC_BZ_DVCD, SUBSTR(ARC_INPL_CD,1,5) AS PDC_CD, NTNL_CTRY_CD, INRI_RN_KND_CD,
       CASE WHEN PLNO IN (
       		SELECT PLNO
        		FROM FDMTAG04002 a
        		WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
        			AND EXISTS (SELECT 1 FROM FDWTAG04107 b WHERE a.RRNR_TTY_CD = b.RRNR_TTY_CD AND b.CMSN_DVCD = '1')
       ) THEN '01' ELSE '02' END AS CMSN_DVCD,
       SUM(ELP_PRM) AS OGL_ELP_PRM
	FROM FDMTAG04001
  WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
  GROUP BY RRNR_DAT_DVCD, RRNR_CTC_BZ_DVCD, SUBSTR(ARC_INPL_CD,1,5), NTNL_CTRY_CD, INRI_RN_KND_CD,
		       CASE WHEN PLNO IN (
		       		SELECT PLNO
		        		FROM FDMTAG04002 a
		        		WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
		        			AND EXISTS (SELECT 1 FROM FDWTAG04107 b WHERE a.RRNR_TTY_CD = b.RRNR_TTY_CD AND b.CMSN_DVCD = '1')
		       ) THEN '01' ELSE '02' END;


-- 일반_출재_직전1년경과보험료 (2021.07.23)
SELECT RRNR_CTC_BZ_DVCD, SUBSTR(ARC_INPL_CD,1,5) AS PDC_CD, INER_CHN_DVCD, NTNL_CTRY_CD, RN_KND_CD, T02_RN_RINSC_CD,
       CASE WHEN CMSN_DVCD = '1' THEN '01' ELSE '02' END AS CMSN_DVCD,
       SUM(T02_RN_ELP_PRM) AS RN_ELP_PRM
	FROM FDMTAG04002
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-11),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
	GROUP BY RRNR_CTC_BZ_DVCD, SUBSTR(ARC_INPL_CD,1,5), INER_CHN_DVCD, NTNL_CTRY_CD, RN_KND_CD, T02_RN_RINSC_CD,
				   CASE WHEN CMSN_DVCD = '1' THEN '01' ELSE '02' END;

-- 일반_원수_예정보험료 (2021.07.23)
SELECT RRNR_DAT_DVCD, RRNR_CTC_BZ_DVCD, SUBSTR(ARC_INPL_CD,1,5) AS PDC_CD, INER_CHN_DVCD,
	     SUM(WNCR_CNV_EPCT_PRM) AS OGL_EPCT_PRM
	FROM (
  	SELECT DISTINCT BSE_YM, PLNO, PYM_EPCT_DT, WNCR_CNV_EPCT_PRM
			FROM FDMTAG04003
  		WHERE 1=1
  		  AND BSE_YM = SUBSTR(:ET_PARM02,1,6)
      	AND SUBSTR(PYM_EPCT_DT,1,6) > BSE_YM
      	AND PYM_YN = '0'
  ) A LEFT JOIN (
  	SELECT DISTINCT PLNO, ARC_INPL_CD, RRNR_DAT_DVCD, RRNR_CTC_BZ_DVCD, INER_CHN_DVCD
    	FROM FDMTAG04001
  ) B
  ON A.PLNO = B.PLNO
  GROUP BY RRNR_DAT_DVCD, RRNR_CTC_BZ_DVCD, SUBSTR(ARC_INPL_CD,1,5), INER_CHN_DVCD;

-- 일반_출재_예정보험료 (2021.07.23)
WITH EPCT_RN_PRM AS (
  SELECT PLNO, T02_RN_RINSC_CD, SUM(WNCR_CNV_RN_PRM) AS WNCR_CNV_RN_PRM
    FROM FDMTAG04003
    WHERE 1=1
      AND BSE_YM = SUBSTR(:ET_PARM02,1,6)
    	AND SUBSTR(PYM_EPCT_DT,1,6) > BSE_YM
      AND PYM_YN = '0'
      GROUP BY PLNO, T02_RN_RINSC_CD
)

SELECT B.RRNR_DAT_DVCD, B.RRNR_CTC_BZ_DVCD, SUBSTR(B.ARC_INPL_CD,1,5) AS PDC_CD, B.INER_CHN_DVCD, A.T02_RN_RINSC_CD,
       SUM(A.WNCR_CNV_RN_PRM) AS RN_EPCT_PRM
	FROM EPCT_RN_PRM A
  LEFT JOIN (SELECT DISTINCT PLNO, ARC_INPL_CD, RRNR_DAT_DVCD, RRNR_CTC_BZ_DVCD, INER_CHN_DVCD FROM FDMTAG04002) B
  	ON A.PLNO = B.PLNO
  GROUP BY B.RRNR_DAT_DVCD, B.RRNR_CTC_BZ_DVCD, SUBSTR(B.ARC_INPL_CD,1,5), B.INER_CHN_DVCD, A.T02_RN_RINSC_CD
  HAVING SUM(A.WNCR_CNV_RN_PRM) != 0;

-- 일반_원수_개별추산액 (2021.07.23)
SELECT RRNR_DAT_DVCD, RRNR_DMFR_DVCD, SUBSTR(ARC_INPL_CD,1,5) AS PDC_CD, INER_CHN_DVCD, NTNL_CTRY_CD, INRI_RN_KND_CD,
		   CASE WHEN EXISTS (SELECT 1 FROM FDMTTC04002 B WHERE B.CMSN_DVCD = '1' AND B.PLNO = A.PLNO AND B.CLG_YM = SUBSTR(:ET_PARM02,1,6)) THEN '01' ELSE '02' END AS CMSN_DVCD,
       SUM(LTPD_OST_AMT) AS OGL_OST_AMT
	FROM FDMTTC04001 A
	WHERE CLG_YM = SUBSTR(:ET_PARM02,1,6)
	GROUP BY RRNR_DAT_DVCD, RRNR_DMFR_DVCD, SUBSTR(ARC_INPL_CD,1,5), INER_CHN_DVCD, NTNL_CTRY_CD, INRI_RN_KND_CD,
		  	   CASE WHEN EXISTS (SELECT 1 FROM FDMTTC04002 B WHERE B.CMSN_DVCD = '1' AND B.PLNO = A.PLNO AND B.CLG_YM = SUBSTR(:ET_PARM02,1,6)) THEN '01' ELSE '02' END;

-- 일반_출재_개별추산액 (2021.07.23)
SELECT RRNR_DMFR_DVCD, SUBSTR(ARC_INPL_CD,1,5) AS PDC_CD, INER_CHN_DVCD, NTNL_CTRY_CD, RN_KND_CD, T02_RN_RINSC_CD,
       CASE WHEN CMSN_DVCD = '1' THEN '01' ELSE '02' END AS CMSN_DVCD,
       SUM(RN_LTPD_OST_AMT) AS RN_OST_AMT
	FROM FDMTTC04002
	WHERE CLG_YM = SUBSTR(:ET_PARM02,1,6)
	GROUP BY RRNR_DMFR_DVCD, SUBSTR(ARC_INPL_CD,1,5), INER_CHN_DVCD, NTNL_CTRY_CD, RN_KND_CD, T02_RN_RINSC_CD,
           CASE WHEN CMSN_DVCD = '1' THEN '01' ELSE '02' END;

-- 일반_원수_직전3년보험금손조비 (2021.07.23)
SELECT RRNR_DAT_DVCD,
		   RRNR_DMFR_DVCD,
		   SUBSTR(ARC_INPL_CD,1,5) AS PDC_CD,
       SUM(OGL_PYN_BNF) AS OGL_PYN_BNF,
       SUM(ACCD_IVMT) AS OGL_ACCD_IVMT
	FROM FDMTTC04001
  WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(SUBSTR(:ET_PARM02,1,6),'YYYYMM'), -35), 'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
  GROUP BY RRNR_DAT_DVCD, RRNR_DMFR_DVCD, SUBSTR(ARC_INPL_CD,1,5);

-- 일반_출재_직전3년보험금손조비 (2021.07.23)
SELECT RRNR_DAT_DVCD,
		   RRNR_DMFR_DVCD,
		   SUBSTR(ARC_INPL_CD,1,5) AS PDC_CD,
       SUM(WNCR_CNV_PYN_BNF)AS RN_PYN_BNF,
       SUM(WNCR_CNV_RN_DAG_IVMT) AS RN_ACCD_IVMT
	FROM FDMTTC04002
  WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(SUBSTR(:ET_PARM02,1,6),'YYYYMM'), -35), 'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
  GROUP BY RRNR_DAT_DVCD, RRNR_DMFR_DVCD, SUBSTR(ARC_INPL_CD,1,5);

-- 일반_원수_직전3년연간경과보험료 (2021.07.23)
SELECT SUBSTR(CLG_YM,1,4) AS FY, RRNR_DAT_DVCD, RRNR_CTC_BZ_DVCD, SUBSTR(ARC_INPL_CD,1,5) AS PDC_CD, SUM(ELP_PRM) AS OGL_ELP_PRM
  FROM FDMTAG04001
  WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-35),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
  GROUP BY SUBSTR(CLG_YM,1,4), RRNR_DAT_DVCD, RRNR_CTC_BZ_DVCD, SUBSTR(ARC_INPL_CD,1,5);

-- 일반_출재_직전3년연간경과보험료 (2021.07.23)
SELECT SUBSTR(CLG_YM,1,4) AS FY, RRNR_DAT_DVCD, RRNR_CTC_BZ_DVCD, SUBSTR(ARC_INPL_CD,1,5) AS PDC_CD, SUM(T02_RN_ELP_PRM) AS RN_ELP_PRM
  FROM FDMTAG04002
  WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-35),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
  GROUP BY SUBSTR(CLG_YM,1,4), RRNR_DAT_DVCD, RRNR_CTC_BZ_DVCD, SUBSTR(ARC_INPL_CD,1,5);

-- 일반_원수_직전3년연간손해액 (2021.07.23)
SELECT SUBSTR(CLG_YM,1,4) AS FY, RRNR_DAT_DVCD, RRNR_DMFR_DVCD, SUBSTR(ARC_INPL_CD,1,5) AS PDC_CD, SUM(OGL_PYN_BNF+LTPD_OST_AMT-PTRM_OST_AMT+ACCD_IVMT) AS OGL_LOSS
	FROM FDMTTC04001
	WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-35),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
	GROUP BY SUBSTR(CLG_YM,1,4), RRNR_DAT_DVCD, RRNR_DMFR_DVCD, SUBSTR(ARC_INPL_CD,1,5);

-- 일반_출재_직전3년연간손해액 (2021.07.23)
SELECT SUBSTR(CLG_YM,1,4) AS FY, RRNR_DAT_DVCD, RRNR_DMFR_DVCD, SUBSTR(ARC_INPL_CD,1,5) AS PDC_CD, SUM(WNCR_CNV_PYN_BNF+RN_LTPD_OST_AMT-RN_PTRM_OST_AMT+WNCR_CNV_RN_DAG_IVMT) AS RN_LOSS
  FROM FDMTTC04002
  WHERE CLG_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(:ET_PARM02, 'YYYYMMDD'),-35),'YYYYMM') AND SUBSTR(:ET_PARM02,1,6)
  GROUP BY SUBSTR(CLG_YM,1,4), RRNR_DAT_DVCD, RRNR_DMFR_DVCD, SUBSTR(ARC_INPL_CD,1,5);

-- 일반_상품정보
SELECT DISTINCT PDC_CD, PDC_NM, PDGR_CD, PDGR_NM
	FROM FDWTTP01011
  ORDER BY 1;

---- 일반_사업비율
--SELECT PDC_CD, INER_CHN_DVCD
--	FROM FBMTEX02041
--	WHERE BSE_YM = '202012'
--		AND ASUM_INPD_DVCD = '1'
--		AND ASUM_CMP_OJ_DVCD = '20';
SELECT DISTINCT
       CASE WHEN RRNR_DVCD IN ('01','02') THEN '04'
            WHEN RRNR_DVCD IN ('03') THEN '03'
            END AS  RRNR_DVCD
     , DMFR_DVCD
     , BOZ_CD
     , EXP_RT
FROM KICS_PRM_RPT
WHERE TO_CHAR(BASE_DATE,'YYYYMM') = '202012'
	AND SUBSTR(BOZ_CD, 0, 1) = 'A'
ORDER BY 1, 2, 4, 3;

-- 일반_보험금진전추이
SELECT PDGR_CD, AY, BASE_1, BASE_2, BASE_3, BASE_4, BASE_5, BASE_6, BASE_7
	FROM KICS_RISK_CF_NL_G WHERE BSE_YM = SUBSTR(:ET_PARM02,1,6);

-- 일반_최종손해율
SELECT RRNR_DAT_DVCD, PDGR_CD, FNAL_LSRT
	FROM FBMTST12201
  WHERE BSE_YM = SUBSTR(:ET_PARM02,1,6)
  	AND SQNO = '1';

-- 할인율
SELECT KICS_SCEN_NO, MAT_TERM, SPOT_RATE
	FROM KICS_USER_FSS_SCENARIO
	WHERE FSS_SCEN_TYP = '3100'
		AND BSE_YM = SUBSTR(:ET_PARM02,1,6);

-- 국가그룹
SELECT CNTR_CD, CNTR_CD_NM AS CNTR_NM, CNTR_CATG_CD
	FROM KICS_CNTR_GRP_MAP_NL;
--	WHERE APLY_END_DATE = '21991231';

-- 특약정보
SELECT RRNR_TTY_CD, TTY_CD_NM, TTY_YR
	FROM FDWTAG04107
	WHERE CMSN_DVCD = '1';


--SELECT *
--	FROM FBMTEX02041
--	WHERE BSE_YM = '201912'
--		AND ASUM_INPD_DVCD = '1'
--		AND ASUM_CMP_OJ_DVCD = '10';